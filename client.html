<!DOCTYPE html>
<html>
<head>
    <title>Virtual Assistant Demo</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f9f9f9;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .search-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .browser-simulation {
            margin-top: 20px;
            background: #f5f5f5;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .browser-header {
            background: #e0e0e0;
            padding: 10px;
            border-bottom: 1px solid #ccc;
        }
        .browser-tabs {
            display: flex;
            gap: 2px;
            padding: 0 10px;
            background: #f0f0f0;
            border-bottom: 1px solid #ddd;
            overflow-x: auto;
            white-space: nowrap;
            scrollbar-width: thin;
        }
        .browser-tab {
            padding: 8px 25px 8px 15px;
            background: #e8e8e8;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-top: 5px;
            font-size: 12px;
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            position: relative;
            cursor: pointer;
        }
        .browser-tab.active {
            background: white;
            margin-bottom: -1px;
            padding-bottom: 9px;
        }
        .browser-tab:hover {
            background: #f8f8f8;
        }
        .browser-url {
            display: flex;
            align-items: center;
            padding: 5px;
            background: white;
            border-radius: 4px;
            margin: 5px 0;
        }
        .browser-url input {
            flex: 1;
            border: none;
            padding: 5px;
            font-size: 14px;
            color: #333;
            background: transparent;
        }
        .browser-content {
            padding: 0;
            height: 600px;
            background: white;
            border: none;
            border-radius: 0 0 8px 8px;
            overflow: hidden;
        }
        .browser-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }
        .error {
            padding: 20px;
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 10px;
        }
        input[type="text"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .sources {
            color: #666;
            font-size: 14px;
            margin-top: 10px;
        }
        .timestamp {
            color: #999;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Virtual Assistant Demo</h1>
        <div class="search-container">
            <input type="text" id="query" placeholder="Posez votre question...">
            <button onclick="search()">Rechercher</button>
            <div id="result" class="result"></div>
            <div id="sources" class="sources"></div>
            <div id="timestamp" class="timestamp"></div>
        </div>
        <div class="browser-simulation">
            <h3>Navigation en cours</h3>
            <div class="browser-header">
                <div class="browser-tabs" id="browserTabs"></div>
                <div class="browser-url">
                    <input type="text" id="browserUrl" readonly>
                </div>
            </div>
            <div class="browser-content" id="browserContent"></div>
        </div>
    </div>

    <script>
        let currentTab = 0;
        
        function createSandboxedIframe(content, baseUrl) {
            const iframe = document.createElement('iframe');
            iframe.sandbox = 'allow-same-origin allow-scripts allow-popups allow-forms';
            
            // Crée un blob URL pour le contenu
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            
            iframe.src = url;
            
            // Nettoie le blob URL quand l'iframe est chargé
            iframe.onload = () => {
                URL.revokeObjectURL(url);
                // Ajuste la hauteur si nécessaire
                if (iframe.contentWindow.document.body) {
                    const height = iframe.contentWindow.document.body.scrollHeight;
                    if (height > 600) {
                        iframe.style.height = height + 'px';
                    }
                }
            };
            
            return iframe;
        }
        
        function updateBrowserSimulation(browserState) {
            if (!browserState || !browserState.states) {
                console.log('No browser state available');
                return;
            }
            
            const tabsDiv = document.getElementById('browserTabs');
            const urlInput = document.getElementById('browserUrl');
            const contentDiv = document.getElementById('browserContent');
            
            // Créer les onglets
            tabsDiv.innerHTML = browserState.states.map((state, index) => {
                const title = state.title || new URL(state.url).hostname;
                return `
                    <div class="browser-tab ${index === currentTab ? 'active' : ''}"
                         onclick="switchTab(${index})"
                         title="${title}">
                        ${title}
                    </div>
                `;
            }).join('');
            
            // Mettre à jour l'URL et le contenu
            if (browserState.states[currentTab]) {
                const state = browserState.states[currentTab];
                urlInput.value = state.url;
                
                contentDiv.innerHTML = '';
                
                if (state.status === 'error') {
                    contentDiv.innerHTML = `
                        <div class="error">
                            ${state.content}
                        </div>
                    `;
                } else {
                    // Crée un iframe sandboxé avec le contenu HTML
                    const iframe = createSandboxedIframe(state.html || state.content, state.url);
                    contentDiv.appendChild(iframe);
                }
            }
        }
        
        function switchTab(index) {
            currentTab = index;
            const browserState = JSON.parse(sessionStorage.getItem('browserState'));
            if (browserState) {
                updateBrowserSimulation(browserState);
            }
        }
        
        async function search() {
            const query = document.getElementById('query').value;
            const resultDiv = document.getElementById('result');
            const sourcesDiv = document.getElementById('sources');
            const timestampDiv = document.getElementById('timestamp');
            
            resultDiv.innerHTML = 'Recherche en cours...';
            sourcesDiv.innerHTML = '';
            timestampDiv.innerHTML = '';
            
            try {
                const response = await fetch('http://localhost:8000/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        user_id: 'default-user'
                    }),
                });
                
                const data = await response.json();
                
                if (data.status === 'success') {
                    resultDiv.innerHTML = data.data.answer;
                    sourcesDiv.innerHTML = 'Sources consultées :<br>' + data.sources.join('<br>');
                    timestampDiv.innerHTML = 'Recherche effectuée le : ' + new Date(data.timestamp).toLocaleString();
                    
                    if (data.browser_state) {
                        sessionStorage.setItem('browserState', JSON.stringify(data.browser_state));
                        updateBrowserSimulation(data.browser_state);
                    }
                } else {
                    resultDiv.innerHTML = 'Erreur : ' + JSON.stringify(data);
                }
            } catch (error) {
                resultDiv.innerHTML = 'Erreur : ' + error.message;
                console.error('Error:', error);
            }
        }
        
        // Initialisation
        document.getElementById('query').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                search();
            }
        });
    </script>
</body>
</html>
